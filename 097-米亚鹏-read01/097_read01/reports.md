# x86系统架构概览
###  1、系统级体系结构概览
&emsp;&emsp;系统级体系结构由一组寄存器、数据结构和指令组成，旨在支持基本的系统级操作，如内存管理、中断和异常处理、任务管理和多个处理器的控制。  
&emsp;&emsp;图1提供了适用于32位模式的系统寄存器和数据结构的摘要。适用于IA-32e模式的系统寄存器和数据结构如图2所示。
<div>			<!--块级封装-->
    <center>	<!--将图片和文字居中-->
    <img src=".\images\img1.png"
         alt="图片失踪了"
    />
    图1	IA-32系统级寄存器和数据结构<!--标题-->
    </center>
</div>  

<div>			<!--块级封装-->
    <center>	<!--将图片和文字居中-->
    <img src=".\images\img2.png"
         alt="图片失踪了"/>
    图2	IA-32e模式下的系统级寄存器和数据结构<!--标题-->
    </center>
</div>

#### 1.1 全局和本地描述符表
&emsp;&emsp;**GDT**:全局描述符表，**LDT**:本地描述符表。当在受保护的模式下运行时，所有的**内存访问**都会通过GDT或一个可选的LDT，如图1所示。这些表包含一些条目名为段描述符。段描述符会提供段的基本地址以及访问权限、类型和使用信息。每个段描述符都有一个关联的段选择器。段选择器提供了：

- 指向GDT或LDT的索引（其关联的段描述符的偏移量）
- 全局/本地标志（确定选择器是指向GDT还是LDT）
- 访问权限信息。  

如果要访问段中的字节，必须提供**段选择器**和**偏移量**。段选择器提供对段的段描述符的访问。处理器从段描述符获得段在线性地址空间中的基本地址。然后，偏移量提供了字节相对于基本地址的位置。此机制可用于访问任何有效的代码、数据或堆栈。
&emsp;&emsp;GDT基底的线性地址包含在GDT寄存器（GDTR）中；LDT的线性地址包含在LDT寄存器（LDTR）中。  

#### 1.2 系统段、段描述符和门
&emsp;&emsp;该体系结构还定义了两个系统段：TSS(任务状态段)和LDT。**不认为GDT是一个段，因为它不能通过段选择器和段描述符来访问**。TSS和LDT有专门为制定的段描述符。
&emsp;&emsp;门（调用门、中断门、陷阱门和任务门）一组特殊的描述符。它们为系统程序和处理程序提供受保护的方法，让这些程序可能在与应用程序和大多数程序不同的特权级别上操作。
&emsp;&emsp;如果允许访问目标代码段，则处理器将获得目标代码段的段选择器，并从呼叫门获得到该代码段的偏移量。如果调用需要更改权限级别，则处理器也会切换到目标权限级别的堆栈。新堆栈的段选择器从当前正在运行的任务的TSS中获得。门还促进了16位和32位代码段之间的转换。

#### 1.3 任务状态段和任务门
&emsp;&emsp;TSS(请参见图1)定义了任务执行环境的状态。它包括通用寄存器、段寄存器、EFLAGS寄存器、EIP寄存器和段选择器的三个堆栈段（每个特权级别一个堆栈）。TSS还包括与任务相关联的LDT的段选择器和分页结构层次结构的基本地址。
&emsp;&emsp;保护模式下的所有程序执行都发生在任务（称为当前任务）的上下文中。切换一个任务最简单的方法是调用或跳转到新任务。新任务TSS的段选择器在CALL或JMP指令中给出。在切换任务中，处理器会执行以下操作：
1. 在当前TSS中存储当前任务的状态。 
2. 将任务寄存器载入到新任务的段选择器中。 
3. 通过GDT中的段描述符访问新的TSS。 
4. 将新任务的状态从新的TSS加载到通用寄存器、段寄存器、LDTR、控制寄存器CR3（寻呼结构层次结构的基本地址）、EFLAGS寄存器和EIP寄存器中。 
5. 开始执行新的任务。

也可以通过任务门访问任务。任务门类似于呼叫门，只是它通过一个段选择器提供了对TSS的访问。

#### 1.4 中断和异常处理
&emsp;&emsp;外部中断、软件中断和异常都可以通过中断描述符表（IDT）进行处理。IDT存储了一组门描述符，它们提供对中断和异常处理程序的访问。和GDT一样，**IDT也不是一个段**。IDT基部的线性地址包含在IDT寄存器（IDTR）中。
&emsp;&emsp;IDT中的门描述符可以是中断、陷阱或任务门描述符。为了访问中断或异常处理程序，处理器首先从内部硬件、外部中断控制器或通过INT、INTO、INT 3或BOUND指令从软件接收中断向量。中断向量为IDT提供了一个索引。如果所选的门描述符是中断门或陷阱门，则将以类似于通过调用门调用过程的方式访问关联的处理程序过程。如果描述符是一个任务门，则可以通过任务开关访问该处理程序。

#### 1.5 内存管理
&emsp;&emsp;系统体系结构支持内存或虚拟内存的直接物理寻址(通过页面调度)。当使用物理寻址时，线性地址被视为物理地址。当使用内存分页时：所有的代码、数据、堆栈和系统段（包括GDT和IDT）都可以被分页，只有最近访问的页面被保存在物理内存中。页面（有时称为页面帧）在物理内存中的位置包含在分页结构中。
&emsp;&emsp;分页结构层次的基本物理地址包含在控制寄存器CR3中。分页结构中的条目确定了页面基础的物理地址、访问权限和内存管理信息。
&emsp;&emsp;要使用此分页机制，需要将线性地址分成几部分。这些部分在分页结构和页面框架中提供了单独的偏移量。一个系统可以有一个或多个分页结构的层次结构。

#### 1.6 系统寄存器
为了帮助初始化处理器和控制系统操作，系统体系结构在EFLAGS寄存器和几个系统寄存器中提供了系统标志：

1. EFLAGS寄存器中的系统标志和IOPL字段控制任务和模式切换、中断处理、指令跟踪和访问权限。
2. 控制寄存器（CR0、CR2、CR3和CR4）包含用于控制系统级操作的各种标志和数据字段。这些寄存器中的其他标志用于表示对操作系统或执行系统中的特定处理器功能的支持。
3. 调试寄存器（图1中未显示）允许设置用于调试程序和系统软件的断点。
4. GDTR、LDTR和IDTR寄存器包含它们各自表的线性地址和限制大小。
5. 任务寄存器包含当前任务的TSS的线性地址和大小。
6. 特定于模型的寄存器（MSRs）是一组主要可用于操作系统或执行程序（即运行在特权级别0上的代码）的寄存器。这些寄存器的数量和功能在Intel 64和IA-32处理器家族的不同成员中有所不同。

大多数系统通过应用程序限制对系统寄存器（EFLAGS寄存器除外）的访问。但是，可以设计所有程序和过程运行在最高特权级别（特权级别0）。在这种情况下，将允许应用程序修改系统寄存器。

###  2、实模式和保护模式转换
在转化之前，先介绍实模式和保护模式：
- 实模式：这个模式提供了一些Intel8086的编程模式和一些扩展，处理器在上电或者重启之后会默认进入到实模式。
- 保护模式：处理器的原生模式，在该模式涵盖了处理器的所有特点和指令，有最好的性能。

实模式和保护模式的转化过程主要有以下几个步骤：
1. 屏蔽中断。因为在实模式下，中断有BIOS处理，进入保护模式之后，中断将交给IDT处理，而在刚刚进入保护膜似的时候IDTR是空的，一旦在这个时候出现中断，则会导致CPU方发生异常，所以要先关中断
2. 初始化GCT
3. 设置CR0寄存器的PE标志进入保护模式
4. 执行JMP，重置CS寄存器
5. 加载LDTR寄存器和IDTR寄存器
6. 开中断

### 3、 80x86系统指令寄存器
#### 3.1 EFLAGS标志寄存器
有助于系统进行初始化操作以及系统控制，80x86提供了一个标志寄存器
<div>			<!--块级封装-->
    <center>	<!--将图片和文字居中-->
    <img src=".\images\img3.png"
         alt="图片失踪了"/>
    </center>
</div>

对各寄存器进行说明如下：
- **TF**  Trap (bit 8)：设置启用单步执行方式，在单步执行方式下，处理器会在每一个指令执行之后产生一个调试异常
- **IF**  Interrupt enable (bit 9)：控制处理器对可屏蔽的硬件中断请求的响应
- **IOPL** I/O privilege level field (bits 12 and 13)：指示当前正在运行的程序或任务的I/O权限级别（IOPL）
- **NT**  Nested task (bit 14)：控制中断和调用任务的链接。处理器在对由CALL指令、中断或异常启动任务的调用时设置此标志。
- **RF**  Resume (bit 16)：控制处理器对指令断点条件的响应。
- **VM**  Virtual-8086 mode (bit 17)：设置为启用虚拟-8086模式;清除以返回到受保护模式。
- **AC**  Alignment check (bit 18)：在控制寄存器CR0中设置此标志和AM标志，以启用内存引用的对齐检查；清除AC标志和/或AM标志，以禁用对齐检查。
- **VIF** Virtual Interrupt (bit 19)：包含IF标志的虚拟映像。
- **VIP** Virtual interrupt pending (bit 20)：由软件设置，表示中断正在等待；清除，表示没有中断
- **ID** Identification (bit 21)：程序或过程设置或清除此标志的能力表示支持CPUID指令

#### 3.2 内存管理寄存器
<div>			<!--块级封装-->
    <center>	<!--将图片和文字居中-->
    <img src=".\images\img4.png"
         alt="图片失踪了"/>
    </center>
</div>
&emsp;&emsp;处理器提供了四个内存管理寄存器（GDTR、LDTR、IDTR和TR），它们指定了控制分段内存管理的数据结构的位置（参见图2-6）。

- Global Descriptor Table Register (**GDTR**)：GDTR寄存器保存基本地址（保护模式下32位；IA-32e模式下64位）和GDT的16位表限制。基本地址指定GDT的字节0的线性地址；表限制指定表中的字节数。
- Local Descriptor Table Register (**LDTR**)：LDTR寄存器包含16位段选择器、基本地址（保护模式为32位；IA-32e模式为64位）、段限制和LDT的描述符属性。基本地址指定LDT段的字节0的线性地址；段限制指定段中的字节数。
- IDTR Interrupt Descriptor Table Register(**IDTR**)：IDTR寄存器保存基本地址（保护模式32位；IA-32e模式64位）和IDT的16位表限制。基本地址指定IDT的字节0的线性地址；表限制指定表中的字节数。
- Task Register (**TR**)：任务寄存器包含16位段选择器、基本地址（保护模式32位；IA-32e模式64位）、段限制和当前任务TSS的描述符属性。选择器引用了GDT中的TSS描述符。基地址指定TSS的字节0的线性地址；段限制指定TSS中的字节数。

#### 3.3 控制寄存器
控制寄存器（CR0、CR1、CR2、CR3和CR4；参见图2-7）确定处理器的工作模式和当前执行的任务的特征。这些寄存器在所有的32位模式和兼容性模式下都是32位的。
<div>			<!--块级封装-->
    <center>	<!--将图片和文字居中-->
    <img src=".\images\img5.png"
         alt="图片失踪了"/>
    </center>
</div>
着重介绍一下重要的一些标志位：

- **PG** Paging (bit 31 of CR0)：设置时启用分页；清除时禁用分页
- **CD** Cache Disable (bit 30 of CR0)：当CD和NW标志被清除时，将启用处理器内部（和外部）缓存中的整个物理内存的内存位置的缓存
- **NW** Not Write-through (bit 29 of CR0)：当NW和CD标志清晰时，启用回写或重写，并启用无效周期
- **AM** Alignment Mask (bit 18 of CR0)：在设置时启用自动对齐检查；在清除时禁用对齐检查。
- **WP** Write Protect (bit 16 of CR0)：设置时，禁止主管级程序写入只读页面；清除后，允许主管级程序写入只读页面
- **NE** Numeric Error (bit 5 of CR0)：在设置时启用报告FPU错误的x87的原生（内部）机制；在清除时启用PC式的x87 FPU错误报告机制。
- **EM** Emulation (bit 2 of CR0)：表示设置时处理器没有内部或外部x87 FPU；表示清除时存在x87 FPU。
- **MP** Monitor Coprocessor (bit 1 of CR0)：控制WAIT（或FWAIT）指令与TS标志（CR0的第3位）的交互作用。
- **PE** Protection Enable (bit 0 of CR0)：设置时启用保护模式；清除时启用真实地址模式。
- **PCD** Page-level Cache Disable (bit 4 of CR3)：控制用于访问当前分页结构层次结构的第一个分页结构的内存类型。
- **PWT** Page-level Write-Through (bit 3 of CR3)：控制用于访问当前分页结构层次结构的第一个分页结构的内存类型。

### 4、  系统指令
GDTR、LDTR、IDTR和TR寄存器每个都有一个加载和存储指令，用于将数据载入寄存器并存储数据：
- **LGDT** (Load GDTR Register)：将GDT基地址和限长从内存加载到GDTR寄存器中。
- **SGDT** (Store GDTR Register)：将GDT基地址和限长从GDTR寄存器存储到内存中。
- **LIDT** (Load IDTR Register)：将IDT基地址和限长从内存加载到IDTR寄存器中。
- **SIDT** (Load IDTR Register)：将IDT基地址和限长从IDTR寄存器存储到内存中。
- **LLDT** (Load LDT Register)：将LDT段选择器和段描述符从内存中加载到LDTR中。
- **SLDT** (Store LDT Register)：将LDT段选择器从LDTR寄存器存储到内存或通用寄存器中
- **LTR** (Load Task Register)：将TSS的段选择器和段描述符从内存加载到任务寄存器中。(段选择器操作数也可以位于通用寄存器中)。
- **STR** (Store Task Register):将当前任务TSS的段选择器从任务寄存器存储到存储器或通用寄存器中。





